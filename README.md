# Dapr Actor Experiment

A minimal demo of Dapr actors application in Go, demonstrating actor state management and method invocation patterns with API-contract-first development.

> **Note**: This documentation was largely generated by AI to provide comprehensive examples and explanations.

## Overview

This project showcases:
- **API-Contract-First Development**: Define APIs with OpenAPI specifications, generate type-safe Go code
- **Dapr Actor Pattern**: Stateful actor implementation with persistent state
- **Multiple Actor Types**: Support for different actor patterns in a single application
- **Counter Actor**: Simple state-based counter with increment, decrement, get, and set operations
- **Bank Account Actor**: Event-sourced bank account demonstrating transaction history and audit trails
- **Docker-Only Setup**: Simple deployment using Docker Compose, no Dapr CLI required

## Quick Start

### Prerequisites
- Docker and Docker Compose (required)
- Go 1.19+ (optional, for local development)

### Run the Demo

The simplest way to run the demo:

```bash
# Clone and navigate to the repository
git clone https://github.com/shogotsuneto/dapr-actor-experiment.git
cd dapr-actor-experiment

# Start all services using Docker Compose
./scripts/run-docker.sh

# Test the service
./scripts/test-multi-actors.sh

# Or test individual actor types:
# ./scripts/test-counter-actor.sh
# ./scripts/test-bank-account-actor.sh

# Cleanup when done
docker compose down
```

This approach:
- Uses Docker Compose for declarative service management
- Builds Go applications from source automatically inside containers
- Uses Redis state store and Dapr sidecar containers
- Requires only Docker and Docker Compose

### Alternative Commands

You can also run Docker Compose commands directly:

```bash
# Start services (builds from source automatically)
docker compose up -d

# Test the service  
./scripts/test-multi-actors.sh

# Or test individual actor types:
# ./scripts/test-counter-actor.sh  
# ./scripts/test-bank-account-actor.sh

# Stop services
docker compose down
```

## Building

The project includes a Makefile for common tasks:

```bash
# Build all binaries
make build

# Run tests  
make test

# Clean build artifacts
make clean

# Show help
make help
```

## Project Structure

```
├── api-generation/             # API-Contract-First Development Framework
├── cmd/                       # Main applications
│   ├── server/               # Actor service application
│   └── client/               # Demo client application
├── internal/                  # Private application code
│   ├── actor/                # Actor implementations
│   └── generated/            # Generated code from API schemas
├── configs/dapr/             # Dapr components and configuration
├── scripts/                  # Build and deployment scripts
├── docs/                     # Additional documentation
└── Makefile                  # Build automation
```

## Architecture

```
┌─────────────────┐    ┌─────────────────┐    ┌─────────────────┐
│                 │    │                 │    │                 │
│     Client      │───▶│  Dapr Sidecar   │───▶│  Actor Service  │
│                 │    │   (HTTP API)    │    │   (CounterActor)│
└─────────────────┘    └─────────────────┘    └─────────────────┘
                                │                        │
                                │                        │
                                ▼                        ▼
                       ┌─────────────────┐    ┌─────────────────┐
                       │                 │    │                 │
                       │      Redis      │◀───│  State Manager  │
                       │  (State Store)  │    │                 │
                       └─────────────────┘    └─────────────────┘
```

## Features

### Actor Implementation
- **CounterActor**: State-based actor with persistent counter value using generated OpenAPI types
- **BankAccountActor**: Event-sourced actor with transaction history and full audit trail
- **Operations**: CounterActor (`get`, `increment`, `decrement`, `set`), BankAccountActor (`createAccount`, `deposit`, `withdraw`, `getBalance`, `getHistory`)
- **State Persistence**: Automatic state management via Dapr state store
- **Event Sourcing**: BankAccountActor demonstrates event sourcing with complete transaction history
- **Type Safety**: Contract-compliant implementation with compile-time validation for multiple actor types

### Demo Client
- Demonstrates all actor operations with comprehensive logging
- Shows state persistence across operations and multiple actor instances



## Manual Testing

### Using curl

Once the server is running, you can test the actor directly:

```bash
# Get current counter value
curl http://localhost:3500/v1.0/actors/CounterActor/counter-1/method/get

# Increment counter
curl -X POST http://localhost:3500/v1.0/actors/CounterActor/counter-1/method/increment

# Decrement counter  
curl -X POST http://localhost:3500/v1.0/actors/CounterActor/counter-1/method/decrement

# Set counter to specific value
curl -X POST http://localhost:3500/v1.0/actors/CounterActor/counter-1/method/set \
  -H "Content-Type: application/json" \
  -d '{"value": 42}'

# Test different actor instance
curl http://localhost:3500/v1.0/actors/CounterActor/counter-2/method/get
```

### Testing BankAccountActor (Event-Sourced)

```bash
# Create bank account
curl -X POST http://localhost:3500/v1.0/actors/BankAccountActor/account-123/method/createAccount \
  -H "Content-Type: application/json" \
  -d '{"ownerName": "John Doe", "initialDeposit": 1000.0}'

# Deposit money
curl -X POST http://localhost:3500/v1.0/actors/BankAccountActor/account-123/method/deposit \
  -H "Content-Type: application/json" \
  -d '{"amount": 250.0, "description": "Salary deposit"}'

# Withdraw money
curl -X POST http://localhost:3500/v1.0/actors/BankAccountActor/account-123/method/withdraw \
  -H "Content-Type: application/json" \
  -d '{"amount": 50.0, "description": "ATM withdrawal"}'

# Get current balance
curl http://localhost:3500/v1.0/actors/BankAccountActor/account-123/method/getBalance

# Get transaction history (shows event sourcing power!)
curl http://localhost:3500/v1.0/actors/BankAccountActor/account-123/method/getHistory
```

### Automated Testing

Use the comprehensive test script to test both actor types:

```bash
# Test both state-based and event-sourced patterns
./scripts/test-multi-actors.sh

# Or test individual actor types:
# ./scripts/test-counter-actor.sh
# ./scripts/test-bank-account-actor.sh
```

### Health Checks

```bash
# Check Dapr sidecar health
curl http://localhost:3500/v1.0/healthz

# Check actor service health
curl http://localhost:8080/health

# Get service status
curl http://localhost:8080/status
```

## Development

### API Contract Generation (Advanced)

For API-contract-first development with code generation:

```bash
# Generate types and interfaces from OpenAPI schema
cd api-generation && ./tools/scripts/install.sh
./tools/scripts/generate.sh openapi schemas/openapi/multi-actors.yaml
```

See **[API Generation README](api-generation/README.md)** for comprehensive documentation.

### For Local Development

If you want to modify the code and test changes:

1. **Make your changes** to the Go code in `cmd/server/` or `cmd/client/`

2. **Rebuild and test**:
   ```bash
   # Rebuild containers and restart
   docker compose build
   docker compose up -d redis actor-service actor-service-dapr
   
   # Test your changes
   ./scripts/test-multi-actors.sh  # Test all actors
   # OR
   ./scripts/test-counter-actor.sh      # Test CounterActor only
   ./scripts/test-bank-account-actor.sh # Test BankAccountActor only
   ```

3. **View logs** for debugging:
   ```bash
   # Actor service logs
   docker compose logs -f actor-service
   
   # Dapr sidecar logs
   docker compose logs -f actor-service-dapr
   ```

### Running Client Demo

To run the client demo:

```bash
# Start the client with Docker Compose
docker compose --profile client up client client-dapr

# Or run locally (requires server to be running)
go run ./cmd/client
```

## Actor API Reference

### CounterActor Methods

| Method    | Description              | Request Body      | Response         |
|-----------|--------------------------|-------------------|------------------|
| `get`     | Get current value        | None              | `{"value": int}` |
| `increment` | Increment by 1         | None              | `{"value": int}` |
| `decrement` | Decrement by 1         | None              | `{"value": int}` |
| `set`     | Set to specific value    | `{"value": int}`  | `{"value": int}` |

### Actor State

Each actor instance maintains its own counter state:
- **Actor Type**: `CounterActor`
- **Actor ID**: User-defined (e.g., `counter-1`, `counter-2`)
- **State**: Persistent integer counter value
- **Default**: Counter starts at 0 for new instances

## Configuration

### Dapr Configuration
- **State Store**: Redis with actor state store enabled
- **API**: HTTP API v1 enabled for actors
- **Timeouts**: 1h idle timeout, 30s scan interval
- **Tracing**: Full sampling for development

### Docker Configuration
- **Base Images**: Alpine Linux for minimal size
- **Health Checks**: Built-in health monitoring
- **Networking**: Bridge network with service communication

## Troubleshooting

### Common Issues

1. **Port conflicts**: Ensure ports 3500, 6379, 8080 are available
2. **Docker permissions**: Ensure user has Docker permissions
3. **Service startup**: Wait for health checks before testing

### Logs

View service logs:
```bash
# Actor service logs
docker compose logs -f actor-service

# Dapr sidecar logs  
docker compose logs -f actor-service-dapr

# Redis logs
docker compose logs -f redis
```

## Documentation

This repository includes detailed documentation on various aspects of Dapr actors:

### Architecture and Concepts
- **[Multiple Actors](docs/multiple-actors.md)** - Complete guide to multiple actor types, state-based vs event-sourced patterns
- **[Client vs Curl](docs/client-vs-curl.md)** - Understand the difference between using the Go client (Dapr SDK) vs direct HTTP calls with curl
- **[Event Sourcing](docs/event-sourcing.md)** - Learn whether this implementation uses event sourcing and understand the state-based approach
- **[Akka Comparison](docs/akka-comparison.md)** - Compare Dapr actors with Akka actors, including mailbox concepts and architectural differences

### Key Insights
- **Multiple Actor Types**: This implementation now supports both state-based (CounterActor) and event-sourced (BankAccountActor) patterns. See [Multiple Actors documentation](docs/multiple-actors.md) for details.
- **Event Sourcing vs State-Based**: CounterActor uses state-based persistence while BankAccountActor demonstrates full event sourcing with audit trails.
- **How does it compare to Akka?** Both implement the actor model but serve different use cases. See [Akka Comparison](docs/akka-comparison.md) for a detailed analysis.
- **Client vs curl difference?** Both send identical HTTP requests to Dapr sidecar, but the Go client provides type safety and better error handling. See [Client vs Curl](docs/client-vs-curl.md) for details.

## Learning Resources

- [Dapr Actors Documentation](https://docs.dapr.io/developing-applications/building-blocks/actors/)
- [Dapr Go SDK](https://docs.dapr.io/developing-applications/sdks/go/)
- [Actor Pattern Overview](https://docs.dapr.io/concepts/actor-pattern/)

## Appendix: Dapr CLI Usage (Optional)

For advanced users who prefer using the Dapr CLI directly:

<details>
<summary>Click to expand Dapr CLI instructions</summary>

### Prerequisites
- Dapr CLI: [Installation Guide](https://docs.dapr.io/getting-started/install-dapr-cli/)

### Setup
1. **Initialize Dapr**:
   ```bash
   dapr init
   ```

2. **Start Redis**:
   ```bash
   docker run -d --name redis-dapr -p 6379:6379 redis:7-alpine
   ```

3. **Run actor service**:
   ```bash
   make build
   dapr run --app-id actor-service --app-port 8080 --dapr-http-port 3500 \
     --components-path ./configs/dapr --config ./configs/dapr/config.yaml -- ./bin/server
   ```

4. **Run client** (in new terminal):
   ```bash
   dapr run --app-id client --dapr-http-port 3501 -- ./bin/client
   ```

5. **Clean up**:
   ```bash
   docker stop redis-dapr && docker rm redis-dapr
   ```

</details>

## License

This project is provided as-is for educational and demonstration purposes.